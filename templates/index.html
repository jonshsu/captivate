<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<body>
<div class="container">
<div class="input-group">
  <input type="text" class="form-control my-3 mr-3" name="raw" id="">
  <button type="button" class="btn btn-danger my-3 mr-3" onclick="clearCells();">Clear Cells</button>
  <button type="button" class="btn btn-primary my-3" onclick="loadDemo();">Load Demo</button>
</div>
<div class="row">
<table class="table">
  <thead>
    <tr>
      <th></th>
      {% for column in columns %}
        <th class="text-center">{{ column }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
  {% for row in rows %}
    <tr>
      <td class="text-center">{{ row }}</td>
      {% for column in columns %}
        <td><input type="text" class="form-control" name="cell" id="{{ column + row }}"></td>
      {% endfor %}
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script>
  let display_data = {};
  let raw_data = {};
  let raw = document.getElementsByName("raw")[0];
  let cells = [...document.getElementsByName("cell")];

  // add event listeners
  raw.addEventListener("focus", focus_raw);
  raw.addEventListener("blur", blur);
  raw.addEventListener("keyup", keyup_raw);

  cells.forEach((element) => {element.addEventListener("focus", focus_cell)});
  cells.forEach((element) => {element.addEventListener("blur", blur)});
  cells.forEach((element) => {element.addEventListener("keyup", keyup_cell)});

  // handle event listeners
  function blur(event) {
    saveInput(event.target);
    event.target.blur();
    setRaw("")
    calculateDisplay();
  }
  function keyup_raw(event) {
    if(event.code == "Enter") {
      blur(event);
    }
    else {
      let id = expandId(event.target.id);
      setCell(id, event.target.value);
    }
  }
  function keyup_cell(event) {
    if(event.code == "Enter") {
      blur(event);
    }
    else {
      setRaw(event.target.value);
    }
  }
  function focus_raw(event) {
    let id = expandId(event.target.id);
    setRaw(raw_data[id.col][id.row]);
  }
  function focus_cell(event) {
    raw.id = event.target.id + "_raw";
    let id = expandId(event.target.id);
    setRaw(raw_data[id.col][id.row]);
    setCell(id, raw_data[id.col][id.row]);
  }

  // helper functions
  function expandId(id_string) {
    let id = id_string.match(/^([A-J])(10|[1-9])/);
    return {"col": id[1], "row": id[2]};
  }
  function concatId(id_dict) {
    return id_dict.col + id_dict.row;
  }

  function saveInput(element) {
    let id = expandId(element.id);
    raw_data[id.col][id.row] = element.value;
    updateRemote();
  }

  function setCell(cell_id, value) {
    document.getElementById(concatId(cell_id)).value = value;
  }

  function setRaw(value) {
    raw.value = value;
  }
  
  function calculateDisplay() {
    display_data = JSON.parse(JSON.stringify(raw_data));
    let alphabet = ["A","B","C","D","E","F","G","H","I","J"];
    for(let i = 1; i <= 10; i++) {
      for(let j = 0; j < 10; j++) {
        let id = {"col": alphabet[j], "row": i};
        let raw_string = raw_data[id.col][id.row];
        
        let new_string = "";
        if(raw_string.length > 0 && raw_string[0] == '=')
          new_string = evalFormula(id, raw_string, {});
        else
          new_string = raw_string;
        display_data[id["col"]][id["row"]] = new_string;
      }
    }
    populateTable();
  }

  function populateTable() {
    let alphabet = ["A","B","C","D","E","F","G","H","I","J"];
    for(let i = 1; i <= 10; i++) {
      for(let j = 0; j < 10; j++) {
        let id = {"col": alphabet[j], "row": i};
        document.getElementById(concatId(id)).value = display_data[id.col][id.row];
      }
    }
  }

  function evalFormula(cell_id, raw_string, used_cells) {
    // debugger;
    let clean_string = raw_string.replace(" ", "");
    if(clean_string.match(/^=([A-J](10|[1-9])\+)+[A-J](10|[1-9])$/)) { // if valid expression
      // console.log("valid expr", cell_id, raw_string, used_cells);
      if(used_cells[concatId(cell_id)] == "") { // check self
        return "Circular";
      }
      used_cells[concatId(cell_id)] = "";
      let total = 0;
      let expr_cells = clean_string.match(/([A-J](10|[1-9]))/g);
      expr_cells.forEach((cell, index) => {expr_cells[index] = expandId(cell)});

      for(const temp_cell of expr_cells) { 
        if(used_cells[concatId(temp_cell)] == "") { // check each in expr
          return "Circular";
        }
      }
      // recursion
      for(const temp_cell of expr_cells) { 
        let temp_num = evalFormula(temp_cell, raw_data[temp_cell.col][temp_cell.row], used_cells);
        if (parseInt(temp_num)) { // every cell has to be valid number
          delete used_cells[concatId(temp_cell)];
          total += parseInt(temp_num);
        }
        else { // return error message
          return temp_num;
        }
      }
      return total;
    }
    else if(parseInt(clean_string)) {
      return clean_string;
    }
    else {
      return "Invalid";
    }
  }

  // api calls
  function fetchRemote() {
    return fetch('/exceldata')
      .then(res => res.json())
      .then(data => {raw_data = data});
  }

  function updateRemote() {
    let config = {
      "method": "POST",
      "headers": {
        'Content-Type': 'application/json'
      },
      "body": JSON.stringify(raw_data)
    };
    fetch('/exceldata', config);
  }

  async function firstLoad() {
    await fetchRemote();
    calculateDisplay();
  }

  // init
  firstLoad();

  // test cases
  function clearCells() {
    raw_data = {
      "A": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "B": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "C": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "D": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "E": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "F": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "G": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "H": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "I": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
      "J": { 1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: "" },
    }
    updateRemote();
    calculateDisplay();
  }

  function loadDemo() {
    raw_data = {
      "A": {1: "1", 2: "1", 3: "=aa", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: ""},
      "B": {1: "1", 2: "2", 3: "=B1+B2", 4: "", 5: "", 6: "=C6+D6", 7: "", 8: "", 9: "", 10: ""},
      "C": {1: "-1", 2: "=A2+B2", 3: "=C2+C3", 4: "", 5: "", 6: "=B6+D6", 7: "", 8: "", 9: "", 10: ""},
      "D": {1: "", 2: "=B2+C2", 3: "", 4: "", 5: "", 6: "=B6+C6", 7: "", 8: "", 9: "", 10: ""},
      "E": {1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: ""},
      "F": {1: "=B2+C1", 2: "1", 3: "=F1+F2", 4: "=F2+F3", 5: "=F3+F4", 6: "=F4+F5", 7: "=F5+F6", 8: "=F6+F7", 9: "=F7+F8", 10: "=F9+F8"},
      "G": {1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: ""},
      "H": {1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "=H9+H9", 10: "=H10+H10"},
      "I": {1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: ""},
      "J": {1: "", 2: "", 3: "", 4: "", 5: "", 6: "", 7: "", 8: "", 9: "", 10: ""}
    }
    updateRemote();
    calculateDisplay();
  }

</script>
</body>